name: Deploy VaquitaPool

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'testnet'
        type: choice
        options:
          - testnet
          - mainnet
      usdc_msv_address:
        description: 'USDC Access Managed MSV contract address'
        required: true
        type: string
      weth_msv_address:
        description: 'WETH Access Managed MSV contract address'
        required: true
        type: string
      usdt_msv_address:
        description: 'USDT Access Managed MSV contract address (testnet only)'
        required: false
        type: string
      cbbtc_msv_address:
        description: 'cbBTC Access Managed MSV contract address (mainnet only)'
        required: false
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly

      - name: Set environment variables
        id: env
        run: |
          # For manual dispatch, use the input
          ENVIRONMENT="${{ github.event.inputs.environment }}"
          
          if [ "$ENVIRONMENT" = "mainnet" ]; then
            echo "RPC_URL=https://mainnet.base.org" >> $GITHUB_OUTPUT
            echo "PRIVATE_KEY_SECRET=PRODUCTION_PRIVATE_KEY" >> $GITHUB_OUTPUT
            echo "CHAIN_ID=8453" >> $GITHUB_OUTPUT
            echo "SCRIPT_FILE=DeployVaquitaPoolBase.s.sol" >> $GITHUB_OUTPUT
            echo "CONTRACT_NAME=DeployVaquitaPoolBaseScript" >> $GITHUB_OUTPUT
          else
            echo "RPC_URL=https://sepolia.base.org" >> $GITHUB_OUTPUT
            echo "PRIVATE_KEY_SECRET=TESTNET_PRIVATE_KEY" >> $GITHUB_OUTPUT
            echo "CHAIN_ID=84532" >> $GITHUB_OUTPUT
            echo "SCRIPT_FILE=DeployVaquitaPoolBaseSepolia.s.sol" >> $GITHUB_OUTPUT
            echo "CONTRACT_NAME=DeployVaquitaPoolBaseSepoliaScript" >> $GITHUB_OUTPUT
          fi
          
          echo "ENVIRONMENT=$ENVIRONMENT" >> $GITHUB_OUTPUT

      - name: Validate inputs
        run: |
          ENVIRONMENT="${{ github.event.inputs.environment }}"
          USDC_MSV="${{ github.event.inputs.usdc_msv_address }}"
          WETH_MSV="${{ github.event.inputs.weth_msv_address }}"
          
          if [ -z "$USDC_MSV" ] || [ "$USDC_MSV" = "0x" ]; then
            echo "‚ùå Error: USDC MSV address is required"
            exit 1
          fi
          
          if [ -z "$WETH_MSV" ] || [ "$WETH_MSV" = "0x" ]; then
            echo "‚ùå Error: WETH MSV address is required"
            exit 1
          fi
          
          if [ "$ENVIRONMENT" = "testnet" ]; then
            USDT_MSV="${{ github.event.inputs.usdt_msv_address }}"
            if [ -z "$USDT_MSV" ] || [ "$USDT_MSV" = "0x" ]; then
              echo "‚ùå Error: USDT MSV address is required for testnet"
              exit 1
            fi
          fi
          
          if [ "$ENVIRONMENT" = "mainnet" ]; then
            CBBTC_MSV="${{ github.event.inputs.cbbtc_msv_address }}"
            if [ -z "$CBBTC_MSV" ] || [ "$CBBTC_MSV" = "0x" ]; then
              echo "‚ùå Error: cbBTC MSV address is required for mainnet"
              exit 1
            fi
          fi
          
          echo "‚úÖ Input validation passed"
          echo "USDC MSV Address: $USDC_MSV"
          echo "WETH MSV Address: $WETH_MSV"
          if [ "$ENVIRONMENT" = "testnet" ]; then
            echo "USDT MSV Address: $USDT_MSV"
          else
            echo "cbBTC MSV Address: $CBBTC_MSV"
          fi

      - name: Build contracts
        run: |
          cd contracts
          forge build

      - name: Deploy to testnet (Base Sepolia)
        if: steps.env.outputs.ENVIRONMENT == 'testnet'
        env:
          PRIVATE_KEY: ${{ secrets[steps.env.outputs.PRIVATE_KEY_SECRET] }}
        run: |
          cd contracts
          echo "üöÄ Deploying VaquitaPool to Base Sepolia testnet..."
          forge script script/${{ steps.env.outputs.SCRIPT_FILE }}:${{ steps.env.outputs.CONTRACT_NAME }} \
            --sig "run(address,address,address)" \
            ${{ github.event.inputs.usdc_msv_address }} \
            ${{ github.event.inputs.weth_msv_address }} \
            ${{ github.event.inputs.usdt_msv_address }} \
            --rpc-url ${{ steps.env.outputs.RPC_URL }} \
            --private-key $PRIVATE_KEY \
            --broadcast \
            --verify \
            --etherscan-api-key ${{ secrets.ETHERSCAN_API_KEY }} \
            --chain ${{ steps.env.outputs.CHAIN_ID }}

      - name: Deploy to mainnet (Base)
        if: steps.env.outputs.ENVIRONMENT == 'mainnet'
        env:
          PRIVATE_KEY: ${{ secrets[steps.env.outputs.PRIVATE_KEY_SECRET] }}
        run: |
          cd contracts
          echo "üöÄ Deploying VaquitaPool to Base mainnet..."
          forge script script/${{ steps.env.outputs.SCRIPT_FILE }}:${{ steps.env.outputs.CONTRACT_NAME }} \
            --sig "run(address,address,address)" \
            ${{ github.event.inputs.usdc_msv_address }} \
            ${{ github.event.inputs.weth_msv_address }} \
            ${{ github.event.inputs.cbbtc_msv_address }} \
            --rpc-url ${{ steps.env.outputs.RPC_URL }} \
            --private-key $PRIVATE_KEY \
            --broadcast \
            --verify \
            --etherscan-api-key ${{ secrets.ETHERSCAN_API_KEY }} \
            --chain ${{ steps.env.outputs.CHAIN_ID }}

      - name: Display deployment details
        run: |
          echo "‚úÖ VaquitaPool deployment completed successfully!"
          echo "Environment: ${{ steps.env.outputs.ENVIRONMENT }}"
          echo "Network: ${{ steps.env.outputs.RPC_URL }}"
          echo "Chain ID: ${{ steps.env.outputs.CHAIN_ID }}"
          echo "Script: ${{ steps.env.outputs.SCRIPT_FILE }}"
          echo ""
          echo "üìã MSV Addresses Used:"
          echo "- USDC MSV: ${{ github.event.inputs.usdc_msv_address }}"
          echo "- WETH MSV: ${{ github.event.inputs.weth_msv_address }}"
          if [ "${{ steps.env.outputs.ENVIRONMENT }}" = "testnet" ]; then
            echo "- USDT MSV: ${{ github.event.inputs.usdt_msv_address }}"
          else
            echo "- cbBTC MSV: ${{ github.event.inputs.cbbtc_msv_address }}"
          fi
          echo ""
          echo "üìã Deployment Summary:"
          echo "- Implementation contract deployed"
          echo "- Proxy contract deployed and initialized"
          echo "- Contract verified on Etherscan"
          echo ""
          echo "üîç Check the transaction details in the logs above for contract addresses."
